<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GPS CSV Logger (1s)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Helvetica,Arial; padding:1rem; max-width:720px; margin:auto}
    button{padding:.6rem 1rem; margin:.25rem}
    textarea{width:100%; height:120px}
    small{color:#666}
    .status{margin:.5rem 0; font-weight:600}
  </style>
</head>
<body>
  <h1>GPS CSV Logger — 1 second</h1>
  <p>Records: <span id="count">0</span></p>
  <div class="status" id="status">stopped</div>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="download" disabled>Download CSV</button>
  <p><small>Columns: timestamp_iso, epoch_ms, latitude, longitude, altitude, accuracy_m, heading_deg, speed_mps</small></p>
  <textarea id="preview" readonly placeholder="CSV preview will appear here"></textarea>

<script>
(function(){
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const dlBtn    = document.getElementById('download');
  const preview  = document.getElementById('preview');
  const statusEl = document.getElementById('status');
  const countEl  = document.getElementById('count');

  let log = [];
  const header = ["timestamp_iso","epoch_ms","latitude","longitude","altitude","accuracy_m","heading_deg","speed_mps"];
  let timer = null;
  let running = false;

  function addRecord(pos){
    const d = new Date();
    const iso = new Date().toISOString();
    const epoch = d.getTime();
    const lat = pos.coords.latitude ?? "";
    const lon = pos.coords.longitude ?? "";
    const alt = pos.coords.altitude ?? "";
    const acc = pos.coords.accuracy ?? "";
    const hdg = pos.coords.heading ?? "";
    const spd = pos.coords.speed ?? "";
    log.push([iso, epoch, lat, lon, alt, acc, hdg, spd]);
    countEl.textContent = log.length;
    preview.value = [header.join(","), ...log.slice(-10).map(r=>r.join(","))].join("\n");
  }

  async function sampleOnce(){
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("Geolocation not available"));
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos),
        err => reject(err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    });
  }

  startBtn.addEventListener('click', async ()=>{
    if (running) return;
    running = true;
    statusEl.textContent = "starting — requesting permission...";
    log = [];
    preview.value = "";
    countEl.textContent = 0;

    try {
      const pos = await sampleOnce();
      addRecord(pos);
      timer = setInterval(async ()=>{
        try {
          const p = await sampleOnce();
          addRecord(p);
        } catch(e) {
          console.warn("sample error:", e);
        }
      }, 1000);
      statusEl.textContent = "recording every 1 second";
      startBtn.disabled = true;
      stopBtn.disabled = false;
      dlBtn.disabled = false;
    } catch(err){
      statusEl.textContent = "permission denied or error: " + (err.message || err.code || err);
      running = false;
    }
  });

  stopBtn.addEventListener('click', ()=>{
    if (timer) { clearInterval(timer); timer = null; }
    running = false;
    statusEl.textContent = "stopped";
    startBtn.disabled = false;
    stopBtn.disabled = true;
  });

  dlBtn.addEventListener('click', ()=>{
    if (!log.length) return alert("No data to download");
    const csvRows = [header.join(",")];
    for (const r of log) csvRows.push(r.join(","));
    const csv = csvRows.join("\n");
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const now = new Date().toISOString().replace(/[:.]/g,"-");
    a.download = `gps-log-${now}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  window.addEventListener('beforeunload', ()=> {
    if (timer) clearInterval(timer);
  });

})();
</script>
</body>
</html>